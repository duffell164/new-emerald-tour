<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Emerald Tour Leaderboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        
        .leaderboard-container {
            max-width: 1300px;
            margin: 0 auto;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden; /* Keeps header from scrolling */
        }

        /* FIXED HEADER SECTION */
        .header {
            background: linear-gradient(135deg, #124d12 0%, #228B22 50%, #1a5e1a 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            font-size: 24px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 4px solid #FFD700;
            position: relative;
        }
        .header img { height: 45px; vertical-align: middle; }
        .logo-left { margin-right: 20px; }
        .logo-right { margin-left: 20px; }

        .info-bar { display: flex; justify-content: space-around; background: #333; color: #ddd; padding: 12px; font-size: 14px; }
        .info-item { font-weight: bold; color: #FFD700; }
        .info-item span { color: white; margin-left: 5px; }

        .venue { background: #444; color: #FFFFF7; padding: 12px; text-align: center; font-size: 18px; font-weight: bold; }
        .venue.major { background: linear-gradient(90deg, #8B6914 0%, #FFD700 50%, #8B6914 100%) !important; color: #000 !important; }

        /* SCROLLABLE TABLE SECTION */
        .table-wrapper {
            width: 100%;
            overflow-x: auto; /* This enables the horizontal swipe */
            -webkit-overflow-scrolling: touch;
        }

        .best-stat {
            color: #d32f2f; /* Professional red */
            font-weight: 800; /* Extra bold */
        }

        table { width: 100%; border-collapse: collapse; min-width: 900px; } /* Min-width forces scroll on small screens */
        th { background-color: #e6e6e6; padding: 12px; text-align: left; font-size: 13px; border-bottom: 2px solid #ddd; color: #444; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 15px; }

        .pos { font-weight: bold; width: 50px; text-align: center; background: #f9f9f9; }
        .player-name { font-weight: 600; color: #1a5e1a; }
        .to-par { font-weight: bold; text-align: center; font-size: 16px; width: 80px; }
        .to-par.under { color: #d32f2f; }
        .to-par.even { color: #2e7d32; }
        .round-score { text-align: center; width: 60px; color: #666; }
        .total { font-weight: bold; text-align: center; width: 70px; background: #fcfcfc; }
        .prize { font-weight: bold; text-align: center; color: #124d12; width: 110px; }

        /* BONUS & HOF SECTIONS */
        .bonus-container, .hof-container { padding: 20px; }
        .section-title { background: #eee; padding: 10px; font-weight: bold; margin-top: 20px; border-radius: 4px; }
        .hof-cards { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 15px; }
        .hof-card { background: #1a1a1a; color: white; padding: 15px; border-radius: 8px; text-align: center; width: 180px; border: 1px solid #FFD700; }
        
        @media (max-width: 600px) {
            .header { font-size: 18px; padding: 20px 10px; }
            .header img { height: 30px; }
        }
    </style>
</head>
<body>

<div class="leaderboard-container">
    <div class="header">
        NEW EMERALD TOUR LEADERBOARD
    </div>

    <div class="info-bar">
        <div class="info-item">Date: <span id="date-field">--</span></div>
        <div class="info-item">Par: <span id="course-par">72</span></div>
        <div class="info-item">Purse: <span id="prize-pool">$500,000</span></div>
    </div>

    <div class="venue" id="venue-field">The Old Oaks Club</div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th class="pos">POS</th>
                    <th>PLAYER</th>
                    <th class="to-par">TO PAR</th>
                    <th class="round-score">R1</th>
                    <th class="round-score">R2</th>
                    <th class="round-score">R3</th>
                    <th class="round-score">R4</th>
                    <th class="total">TOTAL</th>
                    <th class="prize">PRIZE</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                </tbody>
        </table>
    </div>

    <div class="section-title">SEASON STATS</div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>PLAYER</th>
                    <th>POINTS</th>
                    <th>EARNINGS</th>
                    <th>EVENTS</th>
                    <th>FiR %</th>
                    <th>GiR %</th>
                    <th>SCRAM %</th>
                    <th>NTP (ft)</th>
                </tr>
            </thead>
            <tbody id="bonus-body"></tbody>
        </table>
    </div>

    <div class="section-title">SEASON EVENT HISTORY</div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>EVENT</th>
                    <th>VENUE</th>
                    <th>DATE</th>
                    <th>WINNER</th>
                    <th>PRIZE</th>
                </tr>
            </thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>

    <div class="hof-container">
        <div class="section-title" style="text-align:center; color:#124d12;">üèÜ SEASON TOP 3 üèÜ</div>
        <div class="hof-cards" id="hof-display"></div>
    </div>
</div>

<script>
    // 1. DEFINITIONS (This fixes the "Not Defined" error)
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSoGXmOEYNiMsVMIlQv-PCbb_rMZibcL8t1nhjgwUeT-Fi35kBGD6ED81g7zQEsa726jVI7jax5Tvbx/pub?output=csv';
    const GID_LB = '&gid=0';
    const GID_STATS = '&gid=349486530'; // Ensure this matches your Stats tab ID
    const GID_HIST = '&gid=1886101746'; // Replace with your History tab GID

    // 2. MAIN LOAD FUNCTION
async function loadData() {
    const cacheBuster = `&t=${new Date().getTime()}`;

    // Load Leaderboard
    try {
        const res = await fetch(CSV_URL + GID_LB + cacheBuster);
        renderLB(await res.text());
    } catch (e) { console.error("LB Error"); }

    // Load Stats
    try {
        const statRes = await fetch(CSV_URL + GID_STATS + cacheBuster);
        renderStats(await statRes.text());
    } catch (e) { console.error("Stats Error"); }

    // Load History
    try {
        const histRes = await fetch(CSV_URL + GID_HIST + cacheBuster);
        const histText = await histRes.text();
        
        // If Google returns HTML instead of CSV, it means the GID is wrong
        if (histText.includes("<!DOCTYPE")) {
            throw new Error("Invalid GID: Google returned a web page instead of data.");
        }
        
        renderHistory(histText);
    } catch (e) { 
        console.error("History Error:", e);
        document.getElementById('history-body').innerHTML = 
            `<tr><td colspan='5' style='text-align:center; color:red; padding:10px;'>
            Error: ${e.message}
            </td></tr>`;
    }
}

    // 3. RENDER LEADERBOARD
    function renderLB(csv) {
    const rows = csv.split('\n').slice(2); 
    const tbody = document.getElementById('leaderboard-body');
    tbody.innerHTML = '';

    let lastScore = null;
    let lastPos = 0;
    let tieCount = 0;

    rows.forEach((row, idx) => {
        const col = row.split(',').map(item => item.trim());
        if (!col[1] || col[1] === "") return;

        // 1. Calculate the score for ranking
        const scores = [col[3], col[4], col[5], col[6]].map(s => parseInt(s) || 0);
        const valid = scores.filter(s => s > 0);
        const total = valid.reduce((a, b) => a + b, 0);
        const par = parseInt(document.getElementById('course-par').textContent) || 72;
        const toPar = valid.length > 0 ? total - (par * valid.length) : null;
        
        // 2. Handle the "T" logic
        let posDisplay = "";
        if (toPar !== null) {
            if (toPar === lastScore) {
                // It's a tie
                tieCount++;
                posDisplay = "T" + lastPos;
                
                // Update the previous row in the table to also show 'T' if it didn't already
                const previousRowPos = tbody.lastElementChild.querySelector('.pos');
                if (!previousRowPos.innerText.startsWith("T")) {
                    previousRowPos.innerText = "T" + lastPos;
                }
            } else {
                // Not a tie
                lastPos = idx + 1;
                posDisplay = lastPos;
                tieCount = 0;
            }
            lastScore = toPar;
        }

        const toParText = toPar === null ? '-' : (toPar === 0 ? 'E' : (toPar > 0 ? '+' + toPar : toPar));

        tbody.innerHTML += `
            <tr>
                <td class="pos">${posDisplay}</td>
                <td class="player-name">${col[1]}</td>
                <td class="to-par ${toPar < 0 ? 'under' : 'even'}">${toParText}</td>
                <td class="round-score">${col[3] || '-'}</td>
                <td class="round-score">${col[4] || '-'}</td>
                <td class="round-score">${col[5] || '-'}</td>
                <td class="round-score">${col[6] || '-'}</td>
                <td class="total">${total || '-'}</td>
                <td class="prize">${col[8] || '$0'}</td>
            </tr>
        `;
    });
}

    // 4. RENDER STATS & HALL OF FAME
function renderStats(csv) {
    const rows = csv.split('\n').slice(1); 
    const tbody = document.getElementById('bonus-body');
    const hof = document.getElementById('hof-display');
    tbody.innerHTML = '';
    hof.innerHTML = '';

    const players = rows.map(row => {
        const col = row.split(',').map(item => item.trim());
        if (!col[0] || col[0] === "Player Name" || col[0] === "") return null;
        return {
            name: col[0], points: col[1], cash: col[2], events: col[3],
            fir: parseFloat(col[4]) || 0,
            gir: parseFloat(col[5]) || 0,
            scram: parseFloat(col[6]) || 0,
            ntp: parseFloat(col[7]) || 999 
        };
    }).filter(p => p !== null);

    // Calculate the bests
    const bestFir = Math.max(...players.map(p => p.fir));
    const bestGir = Math.max(...players.map(p => p.gir));
    const bestScram = Math.max(...players.map(p => p.scram));
    const bestNtp = Math.min(...players.map(p => p.ntp));

    players.forEach((p, i) => {
        tbody.innerHTML += `
            <tr>
                <td>${p.name}</td>
                <td>${p.points}</td>
                <td>$${p.cash}</td>
                <td>${p.events}</td>
                <td class="${p.fir === bestFir && p.fir > 0 ? 'best-stat' : ''}">${p.fir}%</td>
                <td class="${p.gir === bestGir && p.gir > 0 ? 'best-stat' : ''}">${p.gir}%</td>
                <td class="${p.scram === bestScram && p.scram > 0 ? 'best-stat' : ''}">${p.scram}%</td>
                <td class="${p.ntp === bestNtp && p.ntp < 999 ? 'best-stat' : ''}">${p.ntp}ft</td>
            </tr>
        `;

    function renderHistory(csv) {
        const rows = csv.split(/\r?\n/).filter(row => row.trim() !== "");
        const tbody = document.getElementById('history-body');
        if (!tbody) return;
        tbody.innerHTML = '';
    
        rows.slice(1).forEach(row => {
            const col = row.split(',').map(item => item.trim());
            if (!col[0]) return;
            tbody.innerHTML += `
                <tr>
                    <td>${col[0]}</td>
                    <td>${col[1] || '-'}</td>
                    <td>${col[2] || '-'}</td>
                    <td style="font-weight:bold; color:#124d12;">${col[3] || '-'}</td>
                    <td>${col[4] || '-'}</td>
                </tr>
            `;
        });
    }

        // Hall of Fame top 3
        if (i < 3) {
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            hof.innerHTML += `
                <div class="hof-card">
                    <div style="font-size:30px;">${medals[i]}</div>
                    <div style="font-weight:bold; margin: 5px 0;">${p.name}</div>
                    <div style="color:#FFD700; font-size:12px;">${p.points} Points</div>
                </div>
            `;
        }
    });
}

    // Initialize
    window.onload = loadData;
</script>

</body>
</html>


















