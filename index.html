<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emerald Tour Leaderboard</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #fff; }
        
        /* Main Banner */
        .main-header {
            background-color: #1b5e20;
            color: white;
            text-align: center;
            padding: 15px;
            font-weight: bold;
            font-size: 24px;
            border-bottom: 4px solid #fbc02d;
            text-transform: uppercase;
        }

        /* Black Info Bar */
        .info-bar {
            background-color: #333;
            color: #ffeb3b;
            padding: 10px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            border-bottom: 2px solid #555;
        }

        /* Venue Section */
        .venue-section { text-align: center; padding: 25px 0 10px 0; }
        .venue-section h2 { color: #1b5e20; margin: 0; font-size: 32px; text-transform: uppercase; }
        .venue-section p { font-weight: bold; margin: 10px 0; font-size: 20px; color: #333; }

        /* Tables */
        .table-wrapper { width: 100%; overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 50px; }
        th { background-color: #1b5e20; color: white; padding: 12px; text-transform: uppercase; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }

        /* Platform Icons */
        .platform-icon { width: 18px; height: 18px; vertical-align: middle; margin-right: 8px; }

        /* Soft Emerald Gradient for Top 50% */
        .top-tier {
            background: linear-gradient(90deg, rgba(27, 94, 32, 0.12) 0%, rgba(255, 255, 255, 0) 100%) !important;
        }
        .top-tier td:first-child { border-left: 5px solid #1b5e20; }
    </style>
</head>
<body>

    <div class="main-header">NEW EMERALD TOUR LEADERBOARD</div>

    <div class="info-bar">
        <div>DATE: <span id="event-date" style="color: white;">--</span></div>
        <div>PAR: <span id="course-par" style="color: white;">--</span></div>
    </div>

    <div class="venue-section">
        <h2 id="current-venue">Loading Venue...</h2>
        <p id="total-prize-pool">Total Prize Pool: --</p>
    </div>

    <div class="table-wrapper">
        <h3 style="text-align:center; color:#1b5e20;">TOURNAMENT LEADERBOARD</h3>
        <table>
            <thead>
                <tr>
                    <th>POS</th>
                    <th style="text-align:left;">PLAYER</th>
                    <th>R1</th>
                    <th>R2</th>
                    <th>R3</th>
                    <th>R4</th>
                    <th>TOTAL</th>
                    <th>NTP</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                </tbody>
        </table>
    </div>

    <div class="table-wrapper">
        <h3 style="text-align:center; color:#1b5e20;">SEASON STANDINGS</h3>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th style="text-align:left; padding-left:15px;">Player</th>
                    <th>Events</th>
                    <th>Wins</th>
                    <th style="text-align:right; padding-right:20px;">Earnings</th>
                </tr>
            </thead>
            <tbody id="season-stats-body">
                </tbody>
        </table>
    </div>

    <script>
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSoGXmOEYNiMsVMIlQv-PCbb_rMZibcL8t1nhjgwUeT-Fi35kBGD6ED81g7zQEsa726jVI7jax5Tvbx/pub?output=csv';

        async function fetchData() {
            try {
                const response = await fetch(sheetUrl);
                const csvData = await response.text();
                renderAll(csvData);
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function renderAll(csv) {
            const rows = csv.split(/\r?\n/).filter(row => row.trim() !== "");
            if (rows.length < 2) return;

            // 1. Update Global Headers (Row 2 / Index 2)
            const meta = rows[2].split(',').map(item => item.trim());
            const coursePar = parseInt(meta[11]) || 72;
            
            document.getElementById('current-venue').innerText = meta[10] || "Tournament Venue";
            document.getElementById('course-par').innerText = coursePar;
            document.getElementById('total-prize-pool').innerText = `Total Prize Pool: ${meta[12] || "--"}`;
            document.getElementById('event-date').innerText = meta[13] || "--";

            // 2. Render Leaderboard
            renderLeaderboard(rows, coursePar);

            // 3. Render Season Stats
            renderSeasonStats(rows);
        }

        function renderLeaderboard(rows, coursePar) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            let players = rows.slice(2).map(row => {
                const col = row.split(',').map(item => item.trim());
                if (!col[1]) return null;

                const r1 = parseInt(col[3]) || 0;
                const r2 = parseInt(col[4]) || 0;
                const r3 = parseInt(col[5]) || 0;
                const r4 = parseInt(col[6]) || 0;
                
                const scores = [r1, r2, r3, r4].filter(s => s > 0);
                const total = scores.reduce((a, b) => a + b, 0);
                
                // NTP Logic: If no scores, show "--", otherwise show score vs Par
                let ntp = "--";
                let ntpValue = 999; // For sorting only
                
                if (scores.length > 0) {
                    ntpValue = total - (coursePar * scores.length);
                    ntp = ntpValue > 0 ? `+${ntpValue}` : (ntpValue === 0 ? "E" : ntpValue);
                }

                // Platform Icons
                let icon = "";
                const plat = col[9]?.toLowerCase() || "";
                if (plat.includes("ps")) icon = "https://upload.wikimedia.org/wikipedia/commons/0/00/PlayStation_logo.svg";
                if (plat.includes("xbox")) icon = "https://upload.wikimedia.org/wikipedia/commons/f/f9/Xbox_one_logo.svg";
                if (plat.includes("pc")) icon = "https://upload.wikimedia.org/wikipedia/commons/a/ae/Steam_logo.svg";

                return { name: col[1], r1, r2, r3, r4, total, ntp, ntpValue, icon };
            }).filter(p => p !== null);

            players.sort((a, b) => a.ntpValue - b.ntpValue);

            players.forEach((p, i) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td style="text-align:left;">
                            ${p.icon ? `<img src="${p.icon}" class="platform-icon">` : ''} ${p.name}
                        </td>
                        <td>${p.r1 || '-'}</td>
                        <td>${p.r2 || '-'}</td>
                        <td>${p.r3 || '-'}</td>
                        <td>${p.r4 || '-'}</td>
                        <td style="font-weight:bold;">${p.total || '-'}</td>
                        <td style="color: ${p.ntp > 0 ? 'red' : (p.ntp === 'E' ? 'blue' : 'green')}; font-weight:bold;">${p.ntp}</td>
                    </tr>
                `;
            });
        }

        function renderSeasonStats(rows) {
            const tbody = document.getElementById('season-stats-body');
            tbody.innerHTML = '';

            let players = rows.slice(1).map(row => {
                const col = row.split(',').map(item => item.trim());
                return {
                    name: col[1],
                    events: col[2],
                    wins: col[3],
                    earnings: col[4],
                    numEarnings: parseFloat((col[4] || "0").replace(/[^0-9.-]+/g,""))
                };
            }).filter(p => p.name && p.name !== "Player Name");

            players.sort((a, b) => b.numEarnings - a.numEarnings);
            const halfPoint = Math.ceil(players.length / 2);

            players.forEach((p, i) => {
                const rowClass = i < halfPoint ? 'class="top-tier"' : '';
                tbody.innerHTML += `
                    <tr ${rowClass}>
                        <td style="font-weight:bold;">${i + 1}</td>
                        <td style="text-align:left; padding-left:15px;">${p.name}</td>
                        <td>${p.events}</td>
                        <td>${p.wins}</td>
                        <td style="text-align:right; padding-right:20px; font-weight:bold; color:#1b5e20;">${p.earnings}</td>
                    </tr>
                `;
            });
        }

        fetchData();
    </script>
</body>
</html>
